events {}

http {
  # Minimal hardening
  server_tokens off;

  # Docker embedded DNS (allow upstream re-resolution when containers restart)
  resolver 127.0.0.11 ipv6=off valid=10s;

  upstream orchestrator {
    zone orchestrator 64k;
    server ir-orchestrator:8080 resolve;
  }

  # 443: mTLS required for all API calls
  server {
    listen 443 ssl;

    ssl_certificate     /etc/nginx/pki/server.crt.pem;
    ssl_certificate_key /etc/nginx/pki/server.key.pem;

    # client auth (mTLS)
    ssl_client_certificate /etc/nginx/pki/ca.crt.pem;
    ssl_verify_client on;
    ssl_verify_depth 2;

    location / {
      proxy_pass http://orchestrator;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_http_version 1.1;
    }
  }

  # 8443: enrollment only (no client cert), still TLS
  server {
    listen 8443 ssl;

    ssl_certificate     /etc/nginx/pki/server.crt.pem;
    ssl_certificate_key /etc/nginx/pki/server.key.pem;

    # enrollment bootstrap: no client cert required
    ssl_verify_client off;

    # Only allow enroll + CA download over this port.
    location = /v1/pki/enroll {
      proxy_pass http://orchestrator;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    location = /v1/pki/ca.crt.pem {
      proxy_pass http://orchestrator;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # Bootstrap assets (no client cert) - CA + Windows installer scripts.
    location /bootstrap/ {
      proxy_pass http://orchestrator;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    location = /healthz {
      proxy_pass http://orchestrator;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    location / {
      return 404;
    }
  }
}

