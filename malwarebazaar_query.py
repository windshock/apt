import argparse
import requests
import csv
import os
import sys

from env_utils import load_dotenv

def query_malwarebazaar(api_key, file_hash, verbose=False, current_index=None, total_hashes=None):
    url = 'https://mb-api.abuse.ch/api/v1/'
    headers = {
        "Auth-Key": api_key
    }
    data = {
        "query": "get_info",
        "hash": file_hash
    }

    if verbose:
        progress = f"[{current_index}/{total_hashes}]" if current_index and total_hashes else ""
        sys.stdout.write(f"\r[INFO] Querying MalwareBazaar for hash {progress}: {file_hash} ")
        sys.stdout.flush()

    response = requests.post(url, headers=headers, data=data)

    if response.status_code == 200:
        return file_hash, response.json()  # Include input hash in the response
    else:
        if verbose:
            sys.stdout.write(f"\r[ERROR] Failed to fetch data for {file_hash}, status code: {response.status_code}\n")
            sys.stdout.flush()
        return file_hash, {"error": f"Failed to fetch data, status code: {response.status_code}"}

def write_to_csv(results, output_file, include_header=True):
    with open(output_file, mode='w', newline='', encoding='utf-8') as csvfile:
        fieldnames = ['input_hash', 'result_hash', 'file_name', 'first_seen', 'last_seen', 'malware_family', 'report_link']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)

        # Write header only if include_header is True
        if include_header:
            writer.writeheader()

        for input_hash, result in results:
            for entry in result.get('data', []):
                row = {
                    'input_hash': input_hash,
                    'result_hash': entry.get('sha256_hash', 'N/A'),
                    'file_name': entry.get('file_name', 'N/A'),
                    'first_seen': entry.get('first_seen', 'N/A'),
                    'last_seen': entry.get('last_seen', 'N/A'),
                    'malware_family': entry.get('vendor_intel', {}).get('Triage', {}).get('malware_family', 'N/A'),
                    'report_link': entry.get('vendor_intel', {}).get('FileScan-IO', {}).get('report_link', 'N/A'),
                }
                writer.writerow(row)

def print_to_screen(results, csv_format=False, include_header=True):
    fieldnames = ['input_hash', 'result_hash', 'file_name', 'first_seen', 'last_seen', 'malware_family', 'report_link']

    if csv_format and include_header:
        print(",".join(fieldnames))  # Print header if include_header is True

    for input_hash, result in results:
        for entry in result.get('data', []):
            if csv_format:
                row = [
                    input_hash,
                    str(entry.get('sha256_hash', 'N/A')),
                    str(entry.get('file_name', 'N/A')),
                    str(entry.get('first_seen', 'N/A')),
                    str(entry.get('last_seen', 'N/A')),
                    str(entry.get('vendor_intel', {}).get('Triage', {}).get('malware_family', 'N/A')),
                    str(entry.get('vendor_intel', {}).get('FileScan-IO', {}).get('report_link', 'N/A')),
                ]
                print(",".join(row))
            else:
                print(f"Input Hash: {input_hash}")
                print("Result Hash: ", entry.get('sha256_hash', 'N/A'))
                print("File Name: ", entry.get('file_name', 'N/A'))
                print("First Seen: ", entry.get('first_seen', 'N/A'))
                print("Last Seen: ", entry.get('last_seen', 'N/A'))
                print("Malware Family: ", entry.get('vendor_intel', {}).get('Triage', {}).get('malware_family', 'N/A'))
                print("Report Link: ", entry.get('vendor_intel', {}).get('FileScan-IO', {}).get('report_link', 'N/A'))
                print("-" * 50)

def main():
    load_dotenv()
    # Argument parser
    parser = argparse.ArgumentParser(description="Query MalwareBazaar and save results to a CSV file.")
    parser.add_argument(
        "-k",
        "--api_key",
        help="MalwareBazaar API key. If not provided, MB_API_KEY env var (and .env) will be used.",
    )
    parser.add_argument("-H", "--hash", help="Single file hash to query.")
    parser.add_argument("-f", "--file", help="File containing a list of hashes (one per line).")
    parser.add_argument("-o", "--output", default="malware_data.csv", help="Output CSV file name.")
    parser.add_argument("--no-header", action="store_true", help="Exclude header from the CSV file.")
    parser.add_argument("--print", action="store_true", help="Print results to the screen in human-readable format.")
    parser.add_argument("--print-csv", action="store_true", help="Print results to the screen in CSV format.")
    parser.add_argument("--verbose", action="store_true", help="Show detailed process logs.")

    args = parser.parse_args()

    # Priority: CLI arg > env/.env
    api_key = args.api_key or os.getenv("MB_API_KEY")
    if not api_key:
        parser.error("Missing API key. Provide --api_key or set MB_API_KEY in environment/.env.")

    # Validate input
    if not args.hash and not args.file:
        parser.error("Either --hash or --file must be specified.")

    results = []
    total_hashes = 1 if args.hash else 0

    if args.hash:
        # Query single hash
        result = query_malwarebazaar(api_key, args.hash, verbose=args.verbose, current_index=1, total_hashes=1)
        results.append(result)

    if args.file:
        # Query hashes from file
        if not os.path.exists(args.file):
            print(f"Error: File '{args.file}' does not exist.")
            return

        with open(args.file, "r") as f:
            hash_list = [line.strip() for line in f if line.strip()]
            total_hashes = len(hash_list)

            for idx, file_hash in enumerate(hash_list, start=1):
                result = query_malwarebazaar(api_key, file_hash, verbose=args.verbose, current_index=idx, total_hashes=total_hashes)
                results.append(result)

    # Clear progress line
    if args.verbose:
        sys.stdout.write("\n")

    # Write to CSV
    write_to_csv(results, args.output, include_header=not args.no_header)

    # Print to screen if --print or --print-csv is specified
    if args.print or args.print_csv:
        print_to_screen(results, csv_format=args.print_csv, include_header=not args.no_header)

    print(f"Results saved to {args.output}")

if __name__ == "__main__":
    main()
